---
title: "BST 210 PROJECT"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, warning = FALSE, message = FALSE}

#install.packages("splitstackshape")
#install.packages("gtools")
#install.packages("ResourceSelection")
#install.packages("LogisticDx")
#install.packages("ROCR")
#install.packages("ggplot2")
#install.packages("knitr")
#install.packages("ISLR")

library(tidyverse)
library(dplyr)
library(splines)
library(splines2)
library(ISLR)
library(gtools)
library(splitstackshape)
library(ResourceSelection)
library(LogisticDx)
library(ROCR)
library(ggplot2)

hiv <- read.csv(file ="data/hivstat.csv", header = TRUE, sep = ",")

baseline <- read.csv(file ="data/f00.csv", header = TRUE, sep = ",")

sociodemographic <-read.csv(file ="data/f01.csv", header = TRUE, sep =",")

medhistory <- read.csv(file = "data/hx_cleaned.csv", header = TRUE, sep = ",")

outcome <- read.csv(file = "data/outcome_cleaned.csv", header = TRUE, sep = ",")

alc_drugs <- read.csv(file = "data/f04.csv", header = TRUE, sep = ",")

all <- read.csv(file = "data/finaldataset.csv", header = TRUE, sep = ",")

View(all)


CASEID <- all$CASEID
hivstat <- all$hivstat
speak_spanish <- all$speak_spanish
age <- all$age
ethnicity <- all$ethnicity
educ_level <- all$educ_level
mother_educ <- all$mother_educ
drug <- all$drug
sex_partners <- all$sex_partners
birth_country <- all$birth_country
marital_status <- all$marital_status
household_income <- all$household_income
family_cancer <- all$family_cancer
family_hbp <- all$family_hbp
family_cholesterol <- all$family_cholesterol
family_diabetes <- all$family_diabetes
first_menstruation <- all$first_menstruation
ever_hrt <- all$ever_hrt
aids <- all$aids
cancer <- all$cancer
tb <- all$tb
death <- all$death
first_pos_test <- all$first_pos_test
living_with <- all$living_with
family_kidney <- all$family_kidney
ever_mi <- all$ever_mi
ever_chf <-all$ever_chf
ever_stroke <- all$ever_stroke
ever_highcholesterol <- all$ever_highcholesterol
ever_lung_clot <- all$ever_lung_clot
ever_liverprob <- all$ever_liverprob
ever_marijuana <- all$ever_marijuana
ever_drug_treatment <- all$ever_drug_treatment
shared_needles <- all$shared_needles
ever_in_drug_detox <- all$ever_in_drug_detox
ever_out_drug_detox <- all$ever_out_drug_detox
ever_halfway_house <- all$ever_halfway_house
ever_jail <- all$ever_jail
ever_sex_with_hiv_male <- all$ever_sex_with_hiv_male
ever_sex_with_gay_male <- all$ever_sex_with_gay_male
condom_use <- all$condom_use
ever_anal_sex <- all$ever_anal_sex
ever_sex_toys <- all$ever_sex_toys
sexual_orientation <-all$sexual_orientation
outcome_year <- all$outcomeyear



```
HIV STATUS: 
0: Negative
1: Prevalent 

```{r}
all %>% ggplot()+
  geom_boxplot(aes(factor(hivstat), age))+
  labs(x = "HIV Status", y = "Age")
```
We notice that there is no significant different in the ages of those with HIV infection compared to those without HIV

```{r}

all %>% 
  ggplot(aes(x = factor(hivstat), y = household_income)) +
  geom_boxplot()+
  labs(x = "HIV Status", y = "Household income")

```
There seems to be a little bit of a higher household income among those with HIV than those without HIV

```{r}

aids_proportion <- with(all, table(aids, hivstat)) %>% prop.table(margin = 2)
aids_proportion
```
Among those with HIV (hivstat = 1), only 29% have developed AIDS. This shows that HIV does not always lead to AIDS (contrarily to popular belief)

```{r}
partners_prop <- with(all, table(sex_partners, hivstat)) %>% prop.table(margin = 2)
partners_prop
```
The sex partner categories are as follows : 
1: 0 or no sex partners
2: 1 to 4 partners
3: 5 to 10 partners
4: 11 to 100 partners
5: more than 100 partners
-8 : don't know

We notice that for women with or without HIV status in this cohort, the number of sexual partners does not seem to change considerably.


```{r}
maritalstatus_prop <- with(all, table(marital_status, hivstat)) %>% prop.table(margin = 2)
maritalstatus_prop

```
The marital status categories are as follows: 
1: legally/common-law married
2: not married but living with partner
3: widowed 
4: divorced/annulled
5: separated
6: never married
7: other

We notice that among those with HIV, the biggest proportion has never been married. 
Also, there seems to be a significant bigger percentage of people who are widowed or divorced among the women with HIV than those without (will also see this in the summary of the logistic model below)
```{r}
glm_income <- glm(hivstat ~ I(household_income), data = all, family = binomial)
summary(glm_income)
```
At an alpha = 0.05 significance level, there seems to be a significant relationship between hiv status and household income. 

```{r}
glm_marital <- glm (hivstat ~ as.factor(marital_status) , data = all, family = binomial)
summary(glm_marital)
```
The odds of having HIV is significantly greater for women who are widowed or divorced than for women who are legally married.

```{r}
death_glm <- glm(death ~ ever_highcholesterol , family = binomial)
summary(death_glm)

```
Women who were ever told they had high cholesterol were more likely to die at the end of the study, compared with women who did not have high cholesterol. 


```{r}
glm_drug <- glm(hivstat ~ ever_drug_treatment, family = binomial)
summary(glm_drug)
```
At an alpha = 0.05 significance level, there seems to be a significant relationship between hiv status and receiving drug treatment. 



```{r}
death_logit = glm(death~ age, data = all , family = "binomial")
summary(death_logit)
exp(0.05201*10)
```
For every 10 year increase in age, the model predicts the odds of death to increase by a factor of 1.68
```{r}
hist1 = hist(all$age[all$death==1], plot = F, freq = F)
hist2 = hist(all$age[all$death==0], plot = F, freq = F)
plot( hist1, col=rgb(1,0,0,1/3), xlim=c(15,70), ylim = c(0,250), xlab = "age", main = "")  # first histogram
plot( hist2, col=rgb(0,0,1,1/4), xlim=c(15,70), add=T)  # second
lines(10:80,dnorm((10:80),mean = mean(all$age[all$death==1]), sd = sd(all$age[all$death==1]))*length(all$age[all$death==1])*5, col = rgb(1,0,0,2/3))
lines(10:80,dnorm((10:80),mean = mean(all$age[all$death==0]), sd = sd(all$age[all$death==0]))*length(all$age[all$death==0])*5, col = rgb(0,0,1,2/3))
```
As we can see in the plot of the histogram of women who died (red) and the histogram of the women who did not die (blue), the women who died were on average older than the women who did not die.


#############################################################################################

MODEL BUILDING: predicting HIV

We want to build a model predicting the incidence of HIV and using the following potential predictors:\



"CASEID", "hivstat", "speak_spanish", "age", "ethnicity", "educ_level", "mother_educ", "drug", "sex_partners","first_pos_test", "birth_country", "marital_status", "living_with", "household_income", "family_cancer", "family_hbp", "family_cholesterol", "family_diabetes", "family_kidney" ," first_menstruation", "ever_mi", "ever_chf", "ever_stroke", "ever_highcholesterol", "ever_lung_clot", "ever_liverprob", "ever_hrt", "aids", "cancer", "tb", "death", "ever_marijuana", "ever_drug_treatment", "shared_needles", "ever_in_drug_detox", "ever_out_drug_detox", "ever_halfway_house", "ever_jail", "ever_sex_with_hiv_male", "ever_sex_with_gay_male", "condom_use", "ever_anal_sex", "ever_sex_toys", "sexual_orientation"

```{r}
my_data <- matrix(c(hivstat, age, ethnicity, educ_level, marital_status, living_with, household_income, ever_marijuana, ever_drug_treatment, shared_needles, ever_in_drug_detox, ever_out_drug_detox, ever_halfway_house, ever_jail, ever_sex_with_hiv_male, ever_sex_with_gay_male, condom_use, ever_anal_sex, ever_sex_toys, sexual_orientation), ncol = 20)
cor(my_data, method = "pearson")

```
Based on the correlation matrix, there is a very high correlation between the following variables: ever_drug_treatment, ever_in_drug_detox, ever_out_drug_detox, ever_halfway_house, ever_jail. \
So, we will only include one of these variables in our analysis instead of including them all. 

Based on our research, we are interested in assessing the effects of ever being in jail with the incidence HIV. So, we are going to keep ever_jail in our analysis. 

Going to attempt a forward selection process involving the following covariates : 

age, ethnicity, educ_level, marital_status, living_with, household_income, ever_marijuana, shared_needles, ever_jail, ever_sex_with_hiv_male, ever_sex_with_gay_male, condom_use, ever_anal_sex, ever_sex_toys, sexual_orientation, family_cancer, ever_mi, ever_chf, ever_highcholesterol, ever_liverprob

```{r}
glm1 <- glm(hivstat ~ 1, family = binomial)
forwardModel <- step(glm1, direction = "forward", 
                     scope = (~ age + as.factor(ethnicity) + as.factor(educ_level) + as.factor(marital_status) + living_with + household_income + as.factor(ever_marijuana) + as.factor(shared_needles) + as.factor(ever_jail) + as.factor(ever_sex_with_hiv_male) + as.factor(ever_sex_with_gay_male) + as.factor(condom_use) + as.factor(ever_anal_sex) + as.factor(ever_sex_toys) + as.factor(sexual_orientation) + as.factor(family_cancer) + as.factor(ever_mi) + as.factor(ever_chf) + as.factor(ever_highcholesterol) + as.factor(ever_liverprob)))

```
So our first model option is : 
```{r}

mod.hiv1 <- glm(hivstat ~ as.factor(ever_marijuana) + as.factor(ever_liverprob) + living_with + as.factor(family_cancer) + age + as.factor(ever_chf) + as.factor(ever_anal_sex) + as.factor(ever_jail) + as.factor(shared_needles) + as.factor(educ_level) + as.factor(ever_sex_with_gay_male) + as.factor(marital_status) + as.factor(sexual_orientation) + as.factor(ethnicity), family = binomial)

```

Backward model : 

```{r}
glm2 <- glm(hivstat ~ as.factor(ethnicity) + as.factor(educ_level) + as.factor(marital_status) + living_with + household_income + as.factor(ever_marijuana) + as.factor(shared_needles) + as.factor(ever_jail) + as.factor(ever_sex_with_hiv_male) + as.factor(ever_sex_with_gay_male) + as.factor(condom_use) + as.factor(ever_anal_sex) + as.factor(ever_sex_toys) + as.factor(sexual_orientation) + as.factor(family_cancer) + as.factor(ever_mi) + as.factor(ever_chf) + as.factor(ever_highcholesterol) + as.factor(ever_liverprob), family = binomial)

backwardModel <- step(glm2, direction = "backward")
```
Our second model option is :

```{r}
mod.hiv2 <- glm(hivstat ~ as.factor(ever_highcholesterol) + as.factor(ever_sex_toys) + as.factor(ever_mi) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), family = binomial)
```

We are going to check the goodness of fit with the Hosmer-Lemeshow Goodness of fit test. We are going to use this test because we have a large number of covariate patterns (given our large number of covariates)
```{r}
 
hoslem.test(hivstat, fitted(mod.hiv1))
hoslem.test(hivstat, fitted(mod.hiv2))

```
The p-values of the tests are very large, which is evidence towards goodness of fit of our models. 

Checking the ROC curves:

```{r}

library(pROC)
predprob <- predict(mod.hiv1,type=c("response"))
roccurve <- roc(hivstat ~ predprob)
plot(roccurve,col="red")
auc(roccurve)

predprob <- predict(mod.hiv2,type=c("response"))
roccurve <- roc(hivstat ~ predprob)
plot(roccurve,col="red")
auc(roccurve)
```
Based on the discrimination test, the area under the first ROC curve (0.6933) is smaller than the area under the second ROC curve (0.7404). This means that the probability that the first model will be able to classify a case correctly is 0.6933, while the probability that the second model will be able to classify a case correctly is 0.7404. This tells us that the second model is better in discriminating between a case (hivstat = 1) and a non-case(hivstat = 0).


Checking for outliers with Cook's Distance:

```{r}
cooksd <- cooks.distance(mod.hiv2)

no_outliers <- subset(all, cooksd <= 4/(nrow(all) - 2))
mod_no_outliers <- glm(hivstat ~ as.factor(ever_highcholesterol) + as.factor(ever_sex_toys) + as.factor(ever_mi) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), data = no_outliers, family = binomial)

extractAIC(mod_no_outliers)
```
The AIC of the model without the outliers is 718.36 which is so much lower than the AIC of the model including the outliers. 



Checking for points with high influence with DFFITS:

```{r}
dffits <- dffits(mod.hiv2)
no_highinfl <- subset(all, dffits <= 2*sqrt((6 + 1)/nrow(all)))
mod_no_highinfl <- glm(hivstat ~ as.factor(ever_highcholesterol) + as.factor(ever_sex_toys) + as.factor(ever_mi) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), data = no_highinfl, family = binomial)

summary(mod_no_highinfl)
```
The p-values of the coefficients become smaller when we remove the points with high influence.

Removing the points with large Cook's Distance AND large DFFITS values : 

```{r}

without_all_outliers <- subset(all, cooksd <= 4/(nrow(all) - 2) &  dffits <= 2*sqrt((6 + 1)/nrow(all)))

mod_wo_all_outliers <- glm(hivstat ~ as.factor(ever_highcholesterol) + as.factor(ever_sex_toys) + as.factor(ever_mi) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), data = without_all_outliers, family = binomial) 

summary(mod_wo_all_outliers)
```
This model gives the smallest AIC so far (672.35), which makes sense because we are removing the outliers and high influence points, without which the model is a better fit. 


Checking for potential effect modifiers:
```{r}

#checking if age is an effect modifier:

temp_model <- mod_wo_all_outliers
#summary(temp_model)

temp_ageinteract <- glm(hivstat ~ as.factor(ever_highcholesterol) + as.factor(ever_sex_toys) + as.factor(ever_mi) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use) + age + household_income*age +  as.factor(ever_highcholesterol)*age + as.factor(ever_sex_toys)*age + as.factor(ever_mi)*age +  as.factor(ever_sex_with_hiv_male)*age + as.factor(condom_use)*age, data = without_all_outliers, family = binomial)

summary(temp_ageinteract)

```
age is not an effect modifier of the effect of any of the covariates in the model on HIV status, since the p-values of all the interaction terms are insignificant (> 0.05). 

```{r}
#checking if number of sex partners is an effect modifier

temp_sexpinteract <- glm(hivstat ~ as.factor(ever_highcholesterol) + as.factor(ever_sex_toys) + as.factor(ever_mi) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use) + sex_partners+ household_income*sex_partners +  as.factor(ever_highcholesterol)*sex_partners + as.factor(ever_sex_toys)*sex_partners + as.factor(ever_mi)*sex_partners +  as.factor(ever_sex_with_hiv_male)*sex_partners + as.factor(condom_use)*sex_partners, data = without_all_outliers, family = binomial)

summary(temp_sexpinteract)

```
sex_partners is not an effect modifier of the effect of any of the covariates in the model on HIV status, since the p-values of all the interaction terms are insignificant (> 0.05). 


After talking to Dr. Caitlin Dugdale, infectious disease physician with expertise in HIV research, we are going to construct a model predicting HIV status with the following predictors: ethnicity, drug injection, sex with hiv positive male, household income, number of sex partners, and history of incarceration. She believes that this variables are very important in predicting HIV status.

We will look at the association between hivstatus and each of this covariates alone.
```{r}
mod.ethnicity <- glm(hivstat ~ as.factor(ethnicity), data = all, family = binomial())
summary(mod.ethnicity)
```
 



```{r}
mod.druginjection <- glm(hivstat ~ as.factor(drug), data = all, family = binomial())
summary(mod.druginjection)

```
In our data there does not seem to be an association between HIV status and drug injection. However, we will still include it in our model because the domain experts told us that drug injection is a potential confounder. 

```{r}

mod.hivmale <- glm(hivstat ~ as.factor(ever_sex_with_hiv_male), data = all, family = binomial())
summary(mod.hivmale)
```
There seems to be a significant association between HIV status and ever having sex with an HIV positive male. 

```{r}
mod.household_income <- glm(hivstat ~ household_income, data = all, family = binomial())
summary(mod.household_income)

```
There seems to be a significant association between a woman's household income and HIV status in the US. 

```{r}
mod.sexpartners <- glm(hivstat ~ sex_partners, data = all, family = binomial())
summary(mod.sexpartners)

partners_prop <- with(all, table(sex_partners, hivstat)) %>% prop.table(margin = 2)
partners_prop

```
In our data, the number of sexual partners does not seem to affect one's HIV status, because the proportions of people with HIV and without HIV are the same for the different number of sexual partners. However, we might still include sexual partners in our model because it is a confounder and might provide a better fit for the model. 

```{r}
mod.jail <- glm(hivstat ~ as.factor(ever_jail), data = all, family = binomial())
summary(mod.jail)

```
There is an association between ever being in jail and HIV status.


```{r}
new_model <- glm(hivstat ~ as.factor(ethnicity) + as.factor(drug) + as.factor(ever_sex_with_hiv_male) + household_income + sex_partners + as.factor(ever_jail), data = all, family = binomial())

summary(new_model)
```


```{r}

hoslem.test(hivstat, fitted(new_model))

```
We used the Hosmer and Lemeshow goodness of fit test because we have a very large number of covariate patterns. \
We fail to reject the null hypothesis that the model provides a good fit (p-value > 0.05) and conclude that our model provides a good fit of the data. 

Looking at the ROC and AUC:


```{r}
predprob <- predict(new_model,type=c("response"))
roccurve <- roc(hivstat ~ predprob)
plot(roccurve,col="red")
auc(roccurve)

```
The AUC is greater than 0.7 which is an indication that the model does a good job in discriminating between cases and noncases.




```{r}
start <- glm(hivstat ~ as.factor(ethnicity) + as.factor(educ_level) + as.factor(marital_status) + living_with + household_income + as.factor(drug) + sex_partners + as.factor(ever_marijuana) + as.factor(shared_needles) + as.factor(ever_jail) + as.factor(ever_sex_with_hiv_male) + as.factor(ever_sex_with_gay_male) + as.factor(condom_use) + as.factor(ever_anal_sex) + as.factor(ever_sex_toys) + as.factor(sexual_orientation) + age , family = binomial)

backwardModel <- step(start, direction = "backward")
```

The model that we get using backwards selection is:
```{r}

backward <- glm(hivstat ~ sex_partners + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), data = all, family = binomial())
summary(backward)

hoslem.test(hivstat, fitted(backward))
predprob <- predict(backward,type=c("response"))
roccurve <- roc(hivstat ~ predprob)
plot(roccurve,col="red")
auc(roccurve)

```
This backward model does a better job at discriminating between cases and noncases than the previous model I created.
