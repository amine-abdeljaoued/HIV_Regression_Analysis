---
title: "BST 210 PROJECT"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, warning = FALSE, message = FALSE}

#install.packages("splitstackshape")
#install.packages("gtools")
#install.packages("ResourceSelection")
#install.packages("LogisticDx")
#install.packages("ROCR")
#install.packages("ggplot2")
#install.packages("knitr")
#install.packages("ISLR")

library(tidyverse)
library(dplyr)
library(splines)
library(splines2)
library(ISLR)
library(gtools)
library(splitstackshape)
library(ResourceSelection)
library(LogisticDx)
library(ROCR)
library(ggplot2)
library(pROC)
library(nnet)

hiv <- read.csv(file ="data/hivstat.csv", header = TRUE, sep = ",")

baseline <- read.csv(file ="data/f00.csv", header = TRUE, sep = ",")

sociodemographic <-read.csv(file ="data/f01.csv", header = TRUE, sep =",")

medhistory <- read.csv(file = "data/hx_cleaned.csv", header = TRUE, sep = ",")

outcome <- read.csv(file = "data/outcome_cleaned.csv", header = TRUE, sep = ",")

alc_drugs <- read.csv(file = "data/f04.csv", header = TRUE, sep = ",")

all <- read.csv(file = "data/finaldataset.csv", header = TRUE, sep = ",")

View(all)


CASEID <- all$CASEID
hivstat <- all$hivstat
speak_spanish <- all$speak_spanish
age <- all$age
ethnicity <- all$ethnicity
educ_level <- all$educ_level
mother_educ <- all$mother_educ
drug <- all$drug
sex_partners <- all$sex_partners
birth_country <- all$birth_country
marital_status <- all$marital_status
household_income <- all$household_income
family_cancer <- all$family_cancer
family_hbp <- all$family_hbp
family_cholesterol <- all$family_cholesterol
family_diabetes <- all$family_diabetes
first_menstruation <- all$first_menstruation
ever_hrt <- all$ever_hrt
aids <- all$aids
cancer <- all$cancer
tb <- all$tb
death <- all$death
first_pos_test <- all$first_pos_test
living_with <- all$living_with
family_kidney <- all$family_kidney
ever_mi <- all$ever_mi
ever_chf <-all$ever_chf
ever_stroke <- all$ever_stroke
ever_highcholesterol <- all$ever_highcholesterol
ever_lung_clot <- all$ever_lung_clot
ever_liverprob <- all$ever_liverprob
ever_marijuana <- all$ever_marijuana
ever_drug_treatment <- all$ever_drug_treatment
shared_needles <- all$shared_needles
ever_in_drug_detox <- all$ever_in_drug_detox
ever_out_drug_detox <- all$ever_out_drug_detox
ever_halfway_house <- all$ever_halfway_house
ever_jail <- all$ever_jail
ever_sex_with_hiv_male <- all$ever_sex_with_hiv_male
ever_sex_with_gay_male <- all$ever_sex_with_gay_male
condom_use <- all$condom_use
ever_anal_sex <- all$ever_anal_sex
ever_sex_toys <- all$ever_sex_toys
sexual_orientation <-all$sexual_orientation
outcome_year <- all$outcomeyear



```
HIV STATUS: 
0: Negative
1: Prevalent 

```{r}
all %>% ggplot()+
  geom_boxplot(aes(factor(hivstat), age))+
  labs(x = "HIV Status", y = "Age")
```
We notice that there is no significant different in the ages of those with HIV infection compared to those without HIV

```{r}

all %>% 
  ggplot(aes(x = factor(hivstat), y = household_income)) +
  geom_boxplot()+
  labs(x = "HIV Status", y = "Household income")

```
There seems to be a little bit of a higher household income among those with HIV than those without HIV

```{r}

aids_proportion <- with(all, table(aids, hivstat)) %>% prop.table(margin = 2)
aids_proportion
```
Among those with HIV (hivstat = 1), only 29% have developed AIDS. This shows that HIV does not always lead to AIDS (contrarily to popular belief)

```{r}
partners_prop <- with(all, table(sex_partners, hivstat)) %>% prop.table(margin = 2)
partners_prop
```
The sex partner categories are as follows : 
1: 0 or no sex partners
2: 1 to 4 partners
3: 5 to 10 partners
4: 11 to 100 partners
5: more than 100 partners
-8 : don't know

We notice that for women with or without HIV status in this cohort, the number of sexual partners does not seem to change considerably.


```{r}
maritalstatus_prop <- with(all, table(marital_status, hivstat)) %>% prop.table(margin = 2)
maritalstatus_prop

```
The marital status categories are as follows: 
1: legally/common-law married
2: not married but living with partner
3: widowed 
4: divorced/annulled
5: separated
6: never married
7: other

We notice that among those with HIV, the biggest proportion has never been married. 
Also, there seems to be a significant bigger percentage of people who are widowed or divorced among the women with HIV than those without (will also see this in the summary of the logistic model below)
```{r}
glm_income <- glm(hivstat ~ I(household_income), data = all, family = binomial)
summary(glm_income)
```
At an alpha = 0.05 significance level, there seems to be a significant relationship between hiv status and household income. 

```{r}
glm_marital <- glm (hivstat ~ as.factor(marital_status) , data = all, family = binomial)
summary(glm_marital)
```
The odds of having HIV is significantly greater for women who are widowed or divorced than for women who are legally married.

```{r}
death_glm <- glm(death ~ ever_highcholesterol , family = binomial)
summary(death_glm)

```
Women who were ever told they had high cholesterol were more likely to die at the end of the study, compared with women who did not have high cholesterol. 


```{r}
glm_drug <- glm(hivstat ~ ever_drug_treatment, family = binomial)
summary(glm_drug)
```
At an alpha = 0.05 significance level, there seems to be a significant relationship between hiv status and receiving drug treatment. 



```{r}
death_logit = glm(death~ age, data = all , family = "binomial")
summary(death_logit)
exp(0.05201*10)
```
For every 10 year increase in age, the mod
el predicts the odds of death to increase by a factor of 1.68
```{r}
hist1 = hist(all$age[all$death==1], plot = F, freq = F)
hist2 = hist(all$age[all$death==0], plot = F, freq = F)
plot( hist1, col=rgb(1,0,0,1/3), xlim=c(15,70), ylim = c(0,250), xlab = "age", main = "")  # first histogram
plot( hist2, col=rgb(0,0,1,1/4), xlim=c(15,70), add=T)  # second
lines(10:80,dnorm((10:80),mean = mean(all$age[all$death==1]), sd = sd(all$age[all$death==1]))*length(all$age[all$death==1])*5, col = rgb(1,0,0,2/3))
lines(10:80,dnorm((10:80),mean = mean(all$age[all$death==0]), sd = sd(all$age[all$death==0]))*length(all$age[all$death==0])*5, col = rgb(0,0,1,2/3))
```
As we can see in the plot of the histogram of women who died (red) and the histogram of the women who did not die (blue), the women who died were on average older than the women who did not die.


#############################################################################################

MODEL BUILDING: predicting HIV

```{r}
my_data <- matrix(c(hivstat, age, ethnicity, educ_level, marital_status, living_with, household_income, ever_marijuana, ever_drug_treatment, shared_needles, ever_in_drug_detox, ever_out_drug_detox, ever_halfway_house, ever_jail, ever_sex_with_hiv_male, ever_sex_with_gay_male, condom_use, ever_anal_sex, ever_sex_toys, sexual_orientation), ncol = 20)
cor(my_data, method = "pearson")

```
Based on the correlation matrix, there is a very high correlation between the following variables: ever_drug_treatment, ever_in_drug_detox, ever_out_drug_detox, ever_halfway_house, ever_jail. \
So, we will only include one of these variables in our analysis instead of including them all. 

Based on our research, we are interested in assessing the effects of ever being in jail with the incidence HIV. So, we are going to keep ever_jail in our analysis. 


After talking to Dr. Caitlin Dugdale, infectious disease physician with expertise in HIV research, we are going to construct a model predicting HIV status that includes the following predictors: ethnicity, drug injection, sex with hiv positive male, household income, number of sex partners, and history of incarceration. She believes that these variables are very important in predicting HIV status.

We will look at the association between hivstatus and each of these covariates alone.
```{r}
mod.ethnicity <- glm(hivstat ~ as.factor(ethnicity), data = all, family = binomial())

summary(mod.ethnicity)

OR.ethnicity <- exp(coef(mod.ethnicity)[3]-coef(mod.ethnicity)[2])
OR.ethnicity
CI.ethnicity <- exp(log(OR.ethnicity) + c(-1,1)*1.96*sqrt(vcov(mod.ethnicity)[2,2] + vcov(mod.ethnicity)[3,3] - 2*vcov(mod.ethnicity)[2,3]))
CI.ethnicity
```

 The p-values might be insignificant because the reference group is the group whose responses were NA. But an important comparison that we can make here is between the people who are White and the people who are African American. The odds of having HIV among those who are African American is 1.67 times the odds of having HIV among those who are White on average. With 95% confidence, this odds ratio falls between 1.035 and 2.68. The confidence interval does not include 1, which shows that there is a significant difference between the odds of having HIV among the two groups.



```{r}
mod.druginjection <- glm(hivstat ~ as.factor(drug), data = all, family = binomial())
summary(mod.druginjection)

```
In our data there does not seem to be an association between HIV status and drug injection. However, we will still include it in our model because the domain experts told us that drug injection is an important confounder. 

```{r}

mod.hivmale <- glm(hivstat ~ as.factor(ever_sex_with_hiv_male), data = all, family = binomial())

OR.hivmale <- exp(coef(mod.hivmale)[2]-coef(mod.hivmale)[3])
OR.hivmale
CI.hivmale <- exp(log(OR.hivmale) + c(-1,1)*1.96*sqrt(vcov(mod.hivmale)[2,2] + vcov(mod.hivmale)[3,3] - 2*vcov(mod.hivmale)[2,3]))
CI.hivmale

```
The odds of having HIV among those who have had sex with an HIV positive male is 3.06 times the odds of having HIV among those who never had sex with an HIV positive male. With 95% confidence, this odds ratio falls between 2.08 and 4.51. The confidence interval does not include 1 which tells us that this odds ratio is statistically significant. 

```{r}
mod.income <- glm(hivstat ~ household_income, data = all, family = binomial())
summary(mod.income)

OR.income <- exp(coef(mod.income)[2])
OR.income
CI.income <- exp(log(OR.income) + c(-1,1)*1.96*sqrt(vcov(mod.income)[2,2]))
CI.income

```
There seems to be a significant association between a woman's household income and HIV status in the US. The odds of having HIV among women of a certain household income category is 1.14 times the odds of having HIV among women in 1 level lower household income category on average. With 95% confidence, this odds ratio falls between 1.06 and 1.24. This odds ratio is significant as it excludes 1. \
In our dataset, the results are counterintuitive because one would think that HIV status would negatively affect a woman's household income. But here, it seems that the women with higher household_incomes are more affected by HIV. 

```{r}
mod.sexpartners <- glm(hivstat ~ sex_partners, data = all, family = binomial())
summary(mod.sexpartners)

partners_prop <- with(all, table(sex_partners, hivstat)) %>% prop.table(margin = 2)
partners_prop

IRR.sexp <- exp(coef(mod.sexpartners)[2])
IRR.sexp
CI.sexp <- exp(log(IRR.sexp) + c(-1,1)*1.96*sqrt(vcov(mod.sexpartners)[2,2]))
CI.sexp


```
In our data, the number of sexual partners does not seem to affect one's HIV status, because the proportions of people with HIV and without HIV are the same for the different number of sexual partners. However, we might still include sexual partners in our model because it is a confounder and might provide a better fit for the model. \
The 95% confidence interval of the odds ratio comparing HIV incidence between people with a certain amount of sex partners versus a one level lower amount of sex partners contains 1. So this odds ratio isn't significant in our dataset. 

```{r}
mod.jail <- glm(hivstat ~ as.factor(ever_jail), data = all, family = binomial())
summary(mod.jail)

OR.jail <- exp(coef(mod.jail)[2]-coef(mod.hivmale)[3])
OR.jail
CI.jail<- exp(log(OR.jail) + c(-1,1)*1.96*sqrt(vcov(mod.jail)[2,2] + vcov(mod.jail)[3,3] - 2*vcov(mod.jail)[2,3]))
CI.jail

```
The odds of having HIV among the women who have ever been in jail is 2.12 times the odds of having HIV among those who have never been in jail on average. With 95% confidence, this odds ratio falls between 1.005 and 4.48. 



```{r}
new_model <- glm(hivstat ~ as.factor(ethnicity) + as.factor(drug) + as.factor(ever_sex_with_hiv_male) + household_income + sex_partners + as.factor(ever_jail), data = all, family = binomial())

hoslem.test(hivstat, fitted(new_model))

```


We used the Hosmer and Lemeshow goodness of fit test because we have a very large number of covariate patterns. \
We fail to reject the null hypothesis that the model provides a good fit (p-value = 0.85 > 0.05) and conclude that our model provides a good fit of the data. 

Looking at the ROC and AUC:


```{r}
predprob <- predict(new_model,type=c("response"))
roccurve <- roc(hivstat ~ predprob)
plot(roccurve,col="red")
auc(roccurve)

```
The AUC is smaller than 0.7 which is an indication that the model does not do good job in discriminating between cases and noncases.


BACKWARD SELECTION:

```{r}
start <- glm(hivstat ~ as.factor(ethnicity) + as.factor(educ_level) + as.factor(marital_status) + living_with + household_income + as.factor(drug) + sex_partners + as.factor(ever_marijuana) + as.factor(shared_needles) + as.factor(ever_jail) + as.factor(ever_sex_with_hiv_male) + as.factor(ever_sex_with_gay_male) + as.factor(condom_use) + as.factor(ever_anal_sex) + as.factor(ever_sex_toys) + as.factor(sexual_orientation) + age , family = binomial)

backwardModel <- step(start, direction = "backward")
```

The model that we get using backwards selection is:
```{r}

backward <- glm(hivstat ~ sex_partners + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), data = all, family = binomial())
summary(backward)

hoslem.test(hivstat, fitted(backward))
```
We fail to reject the null hypothesis that the model provides a good fit (p-value = 0.36 > 0.05) and conclude that our model provides a good fit of the data. 
```{r}

predprob <- predict(backward,type=c("response"))
roccurve <- roc(hivstat ~ predprob)
plot(roccurve,col="red")
auc(roccurve)

```

The AUC for the backward model is 0.73 > 0.7 .This backward model does a better job at discriminating between cases and noncases than the previous model I created.

```{r}
start <- glm(hivstat ~ 1, family = binomial)
forwardModel <- step(start, direction = "forward", 
                     scope = (~ as.factor(ethnicity) + as.factor(educ_level) + as.factor(marital_status) + living_with + household_income + as.factor(drug) + sex_partners + as.factor(ever_marijuana) + as.factor(shared_needles) + as.factor(ever_jail) + as.factor(ever_sex_with_hiv_male) + as.factor(ever_sex_with_gay_male) + as.factor(condom_use) + as.factor(ever_anal_sex) + as.factor(ever_sex_toys) + as.factor(sexual_orientation) + age))


```
The model that we get using forward selection includes too many covariates. In our research we prefer simpler models, so we are going to stick to the backward model instead of the forward one. However, we are going to add drug injection to the backward model since it is an important confounder.

```{r}
backward_updated <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), data = all, family = binomial())

summary(backward_updated)

hoslem.test(hivstat, fitted(backward_updated))

predprob <- predict(backward_updated,type=c("response"))
roccurve <- roc(hivstat ~ predprob)
plot(roccurve,col="red")
auc(roccurve)
```
Again we performed a Hosmer and Lemeshow goodness of fit test because we have a large number of covariates. The results point towards evidence of goodness of fit of our model (p-value = 0.41 > 0.05).

Also, the AUC is 0.73 > 0.7 which says that the model does a good job in discriminating between cases and noncases. 

```{r}
extractAIC(backward_updated)
extractAIC(backward)
extractAIC(new_model)

```
The model with the best AIC is the model that we got using backwards selection. However, there is a very small difference between the AIC of the backward model and the updated backward model where we included drug injection as a confounder. Clearly both of these models are better than the initial model we created in terms of AIC. \
For the following analyses, we are going to use the updated backward model.

```{r}
predprob1 <- predict(new_model,type=c("response"))
roccurve1 <- roc(hivstat ~ predprob1)

predprob3 <- predict(backward_updated,type=c("response"))
roccurve3 <- roc(hivstat ~ predprob3)

predprob2 <- predict(backward,type=c("response"))
roccurve2 <- roc(hivstat ~ predprob2)


library(ggplot2)
ggroc(list("Backward Updated" = roccurve3, "Backward" = roccurve2, "First attempt" = roccurve1))+ 
  theme(legend.title = element_blank()) +
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color = "black", linetype = "dashed") +
  xlab("Sensitivity") +
  ylab("Specificity") +
  ggtitle("ROC curves")
```
Checking for EMMs: 

```{r}
#backward_updated <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), data = all, family = binomial())

back1 <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use) + as.factor(condom_use)*sex_partners, data = all, family = binomial())

anova(backward_updated, back1, test = "Chisq")

```
We fail to reject the null hypothesis that the model without the interaction term is preferred. Hence, the number of sex partners is not an effect modifier of the effects of condom use on HIV status.

```{r}
back2 <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use) + as.factor(ever_sex_with_hiv_male)*sex_partners, data = all, family = binomial())

anova(backward_updated, back2, test = "Chisq")
```
We fail to reject the null hypothesis that the model without the interaction term is preferred. Hence, the number of sex partners is not an effect modifier of the effects of having sex with an HIV positive male on HIV status.

```{r}
back3 <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use) + as.factor(ever_marijuana)*sex_partners, data = all, family = binomial())

anova(backward_updated, back3, test = "Chisq")
```
We fail to reject the null hypothesis that the model without the interaction term is preferred. Hence, the number of sex partners is not an effect modifier of the effects of marijuana use on HIV status.

```{r}
back4 <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use) + sex_partners*household_income, data = all, family = binomial())

anova(backward_updated, back4, test = "Chisq")
```
We fail to reject the null hypothesis that the model without the interaction term is preferred. Hence, household income is not an effect modifier of the effects of the number of sex partners on HIV status.

```{r}
back5 <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use) + as.factor(ever_sex_toys)*household_income, data = all, family = binomial())

anova(backward_updated, back5, test = "Chisq")
```
```{r}
back5 <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use) + as.factor(ever_sex_toys)*household_income, data = all, family = binomial())

anova(backward_updated, back5, test = "Chisq")
```
We fail to reject the null hypothesis that the model without the interaction term is preferred. Hence, household income is not an effect modifier of the effects of using sex toys on HIV status.

```{r}
back6 <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use) + as.factor(condom_use)*household_income, data = all, family = binomial())

anova(backward_updated, back6, test = "Chisq")
```
We fail to reject the null hypothesis that the model without the interaction term is preferred. Hence, household income is not an effect modifier of the effects of condom use on HIV status.


Checking for outliers with Cook's Distance:

```{r}
cooksd <- cooks.distance(backward_updated)

no_outliers <- subset(all, cooksd <= 4/(nrow(all) - 2))

back_no_outliers <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), data = no_outliers, family = binomial())

extractAIC(back_no_outliers)
```
The AIC of the model without the outliers is significantly lower than the AIC of the model including the outliers. This shows that in terms of goodness of fit, the model without the outliers performs significantly better than the model with the outliers.


Checking for points with high influence with DFFITS:

```{r}
dffits <- dffits(backward_updated)
no_highinfl <- subset(all, dffits <= 2*sqrt((6 + 1)/nrow(all)))

mod_no_highinfl <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), data = no_highinfl, family = binomial())

extractAIC(mod_no_highinfl)
```
The AIC of the model without the highinfluence points is lower than the AIC of the model including these points. 


Removing the points with large Cook's Distance AND large DFFITS values : 

```{r}

without_all_outliers <- subset(all, cooksd <= 4/(nrow(all) - 2) &  dffits <= 2*sqrt((6 + 1)/nrow(all)))

mod_wo_all_outliers <- glm(hivstat ~ sex_partners + as.factor(drug) + as.factor(ever_marijuana) + as.factor(ever_sex_toys) + household_income + as.factor(ever_sex_with_hiv_male) + as.factor(condom_use), data = without_all_outliers, family = binomial())

extractAIC(mod_wo_all_outliers)

```
This model gives the smallest AIC so far, which makes sense because we are removing the outliers and high influence points, without which the model is a better fit. 

```{r}
library(caret)
prediction <- ifelse(backward_updated$fitted.values > 0.5, 1, 0)
confusionMatrix(data = as.factor(prediction), reference = as.factor(hivstat), positive = "1")
```
We can use our fitted values to actually predict whether a woman in our study in classified as being HIV positive or not. We used a cutoff of 0.5 when classifying the observations. When we do so, we get an accuracy of 84.78% and a sensitivity of 98.36%, which tells us that the model is able to classify an HIV positive person as HIV positive 98.36% of the time. However, the sensitivity is 12.37% which is very low. It tells us that the model is able to classify an HIV negative person as HIV negative only 12.37% of the time. 

```{r}
prediction <- ifelse(backward_updated$fitted.values > 0.74, 1, 0)
confusionMatrix(data = as.factor(prediction), reference = as.factor(hivstat), positive = "1")
```
If we increase our cutoff to 0.74, then we are able to increase the model's specificity, while making sure the sensitivity remains above 90%. 


Interpretations: 
```{r}
summary(backward_updated)
model_coefs <- coef(backward_updated)
vcov(backward_updated)

#Odds ratio of having hiv vs not for those in a category of sex partners vs 1 category lower
exp(model_coefs[2])
exp(model_coefs[2] + c(-1,1)*1.96*sqrt(vcov(mod.hivmale)[2,2]))


#Odds ratio of having hiv vs not for those who have never injected drugs vs those who have.
exp(model_coefs[3])
exp(model_coefs[3] + c(-1,1)*1.96*sqrt(vcov(backward_updated))[3,3])

#odds ratio of having hiv vs not for those who have never used sex toys vs those who have.
exp(model_coefs[6] - model_coefs[5])
exp(model_coefs[6] - model_coefs[5] + c(-1,1)*1.96*sqrt(vcov(backward_updated)[6,6] + vcov(backward_updated)[5,5] - 2*vcov(backward_updated)[5,6]))

#odds ratio of having hiv vs not for those in a household income category vs those in one category lower
exp(model_coefs[7])

#odds ratio of having hiv vs not for those who had sex with an hiv positive male vs those who didn't
exp(model_coefs[8] - model_coefs[9])
exp(model_coefs[8] - model_coefs[9] + c(-1,1)*1.96*sqrt(vcov(backward_updated)[8,8] + vcov(backward_updated)[9,9] - 2*vcov(backward_updated)[8,9]))

#odds ratio of having hiv vs not for those who never used a condom vs those who always do
exp(model_coefs[12]-model_coefs[10])
exp(model_coefs[12] - model_coefs[10] + c(-1,1)*1.96*sqrt(vcov(backward_updated)[12,12] + vcov(backward_updated)[10,10] - 2*vcov(backward_updated)[12,10]))
```


#############################################################################################

MODEL BUILDING: Predicting salary 

We want to understand what important factors define salaries in the women of the WIHS cohort. The point of this part is to build a good model predicting salaries based on the factors that we have. An emphasis is put on hiv_status first to analyze how it correlates with salaries.

To analyze multinomial models, we use the helper function provided in the lecture notes of Topic-9.

```{r}
# A function that will help us summarize multinomial models
summ.MNfit <- function(fit, digits=3){
s <- summary(fit)
for(i in 2:length(fit$lev))
{
##
cat("\nLevel", fit$lev[i], "vs. Level", fit$lev[1], "\n")
##
betaHat <- s$coefficients[(i-1),]
se <- s$standard.errors[(i-1),]
zStat <- betaHat / se
pval <- 2 * pnorm(abs(zStat), lower.tail=FALSE)
##
RRR <- exp(betaHat)
RRR.lower <- exp(betaHat - qnorm(0.975)*se)
RRR.upper <- exp(betaHat + qnorm(0.975)*se)
##
results <- cbind(betaHat, se, pval, RRR, RRR.lower, RRR.upper)
print(round(results, digits=digits))
}
}
```

Let us start with some exploratory data analysis.

```{r}
hist(household_income)
hist(marital_status)
```
There seems to be household_incomes concentrated around the low categories. Given that we know most of our patients are HIV positive, we can already start to think of a correlation. Looking at the marital_status distribution also gives important information. Most of the women of the cohort are either living with someone (1: legally/common-law married or 2: not married but living with partner ) or 6: never married. Category 6 is the most frequent one so we might also think that it plays a big role on the fact that household's incomes are relatively low in that cohort.

We know that we will be using HIV status as one of our predictors. Before starting to fit models, let's see if the proportional odds assumption holds.
We create indicator functions for categories 2 and 5 of household income.

```{r}
ind2 <- ifelse(all$household_income==2,1,0)
ind5 <- ifelse(all$household_income==5,1,0)
```

We then fit models to compare the coefficient of HIV within these 2 categories.
```{r}
md1 <- glm(formula = ind2~hivstat, family=binomial, data=all)
md2 <- glm(formula = ind5~hivstat, family=binomial, data=all)
summary(md1)
summary(md2)
#Checking 95% CI for our two coefficients
coef(md1)[2] + c(-1,1)*1.96*sqrt(vcov(md1)[2,2])
coef(md2)[2] + c(-1,1)*1.96*sqrt(vcov(md2)[2,2])
```
We can see that our coefficients for HIV status are very different across two different categories of household income - this means that the proportional odds assumption does not hold. As HIV status is our main predictor that we will be carrying throughout this analysis, we won't be fitting ordinal models.

We will start with multinomial and logistic models.

Here for hincome, we simply change the NA category to 8 so that it is not taken as the reference category. As for hincome2, we split our categories in 2 with 0 being an income <=2000 or not reported (which is likely to be low) and 1 being >2000.

```{r}
hincome <- household_income
hincome[hincome==-1]=9
hincome2 <- household_income
hincome2[hincome2<=4]=0
hincome2[hincome2>4]=1
hincome
```
We try both a multinomial model with all household income categories and then a simpler logistic regression for "low income" and "high income".
```{r}
mod1_sal = multinom(hincome ~ as.factor(hivstat) , data=all)
summ.MNfit(mod1_sal)

mod2_sal = glm(hincome2 ~ hivstat , data=all,family="binomial")
summary(mod2_sal)
exp(coef(mod2_sal)[2])
exp(confint(mod2_sal))
```
Conclusions from our models:

We can see that most of the relative risk ratios comparing levels of household income vs the lowest one are higher than 1, meaning that the risk ratio of being in high income categories vs the lowest one is higher for HIV positive women than for negative women. This is particularly true when looking at income category 7 ($3001-6250) where the relative risk ratio is of 5.293, with a confidence interval of [1.247, 22.469]. This multinomial model's relative risk ratios comparing levels of household income vs the lowest one are quite confusing, vary a lot across categories and have very wide confidence intervals. We try to fix that using a logistic regression model with only 2 categories: "low income" and "high income"

The results are coherent with the previous model and with our EDA where we noticed that there seemed to be a little bit of a higher household income among those with HIV than those without HIV in our dataset (that as a reminder is only about women in the US). We have that the odds of being in a high income category are 1.618619 higher for women that are positive to HIV vs negative women, with a confidence interval of [0.99127867, 2.795565]


Let us now analyze how the household's income depends on women's marital status.

```{r}
mod1_multi = multinom(hincome ~ as.factor(marital_status) , data=all)
coef(mod1_multi)
summ.MNfit(mod1_multi)

mod2_inh = glm(hincome2 ~ as.factor(marital_status) , data=all,family="binomial")
summary(mod2_inh)
# exp(confint(mod2_inh))

```
We can see that the relative risk ratio of being in high income categories vs low income ones are almost always less than 1 when comparing women that are not married, widowed, divorced etc... against legally married women. This makes sense as the household income naturally increase when it takes into account two people. We can look at some details here and notice for example that:

The risk ratio of being in household income category 8 (>6250) vs category 1 (< 500) for separated women (category 5) is 0.120 times that same risk for married women, with a 95% confidence interval of [0.015, 0,996]. This means that separated women are less likely to be in this high income category. When looking at income category 2, which is closer to 1, the relative risk is not as much different, for instance:
The risk ratio of being in household income category 2 (501-1000) vs category 1 (< 500) for never married (category 6) women is 0.828 times that same risk for married women, with a 95% confidence interval of [0.524, 1.309].

As for the logistic regression model with "high income" and "low income", most of our odds ratio's confidence intervals have their upper boundary lower than one. This confirms our previous sayings as this means that the odds of having a high income are higher for married women than women in other marital status categories.

Thus as we could have guessed, the probability of having a high household income depends a lot on her marital situation. The risk ratio of having a low household income vs higher household income is higher for widowed/divorced women.



We know that Marital status cannot confound the effect of HIV status on household income because marital status can be a downstream consequence of HIV status or household income. For instance, if a person is HIV positive, then this might affect their chances of getting married. So, marital status does not meet the classical definition of a confounder. 

It would however possibly be an effect modifier of this association. Indeed, it would be coherent to see the effect of hiv on household income vary according to the marital status (with a bigger association for women living alone for instance). Let us study that.


```{r}
multi_interact <- multinom(household_income ~ as.factor(marital_status) + as.factor(hivstat) + as.factor(marital_status)*as.factor(hivstat), data = all )
summary(multi_interact)
anova(mod2_multi, multi_interact, test = "Chisq")
```

The Chi square test gives a significant p-value (0.0088 < 0.05). We reject the null hypothesis that the model without the interaction term is preferred and conclude that marital status is an effect modifier of the effects of HIV status on Household income. 

Marital status is an effect modifier of the effect of HIV status on household income. This is coherent because as explained above: "it would be coherent to see the effect of hiv on household income vary according to the marital status (with a bigger association for women living alone for instance)."


Finally, we use other factors to see if we can get a better model: ethnicity, age, educ_level, birth_country, mother_educ, sexual_orientation,ever_jail. Let us start by doing some model selection to see which factors are the most significant here, before analyzing more in details their association with household_income.


```{r}
start <- multinom(household_income ~ as.factor(hivstat)+as.factor(marital_status) + as.factor(ethnicity)+ as.factor(age) + as.factor(educ_level) + as.factor(birth_country) +as.factor(mother_educ)+as.factor(sexual_orientation)+as.factor(ever_jail))

step(start, direction = "backward")
```


```{r}

start <- multinom(household_income~1)
step(start, direction = "forward", 
                     scope = (~ as.factor(hivstat)+as.factor(marital_status) + as.factor(ethnicity)+ as.factor(age) + as.factor(educ_level) + as.factor(birth_country) +as.factor(mother_educ)+as.factor(sexual_orientation)+as.factor(ever_jail)))
```

The model selection approaches seem to reveal that the following factors are the best ones: as.factor(hivstat) + as.factor(ethnicity) + as.factor(educ_level) + as.factor(ever_jail)


```{r}

mod4_multi <- multinom(household_income ~ as.factor(hivstat) + as.factor(ethnicity) + as.factor(educ_level) + as.factor(ever_jail) , data=all)
mod4_multi
```
The AIC is indeed better than when dealing with only hivstat and marital_status. We notice here than the latter was not considered as a good predictor. This is not contradictory because even though it gives more information on the association between hivstat and household_income, other factors might give better results when combined with hivstat. Here the chosen ones are:

Ethnicity: we know that in the US there is a significant association between ethnicity and socioeconomic status and thus salaries.
Education level: this is obvious that salaries are statistically associated with education levels.
Ever been to jail: reinsertion into the professional world after going to jail is very complicated in the US.

We previously saw that marital status was an effect modifier of the effects of HIV status on household income, so we are going to add marital status and the interaction term between marital status and HIV status to our model.
```{r}
fullmod_interact <- multinom(household_income ~ as.factor(hivstat) + as.factor(ethnicity) + as.factor(educ_level) + as.factor(ever_jail) + as.factor(marital_status) +as.factor(hivstat)*as.factor(marital_status) , data=all)
anova(mod4_multi, fullmod_interact)

```
We reject the null hypothesis that the model without the interaction term is preferred (p-value = 0.04 < 0.05) and conclude that adding the interaction term between HIV status and marital status provides a better fit for the model since marital status is indeed an effect modifier of the effect of HIV status on household income.



```{r}
all %>% 
  ggplot(aes(x = factor(educ_level), y = household_income)) +
  geom_boxplot()+
  labs(x = "Education level", y = "Household income")
```
For the education level, the pattern is quite clear: as the level of education increases the household income of a woman increases.

```{r}
all %>% 
  ggplot(aes(x = factor(ever_jail), y = household_income)) +
  geom_boxplot()+
  labs(x = "Ever been to jail", y = "Household income")
```

Ignoring -1 (missing data), we can see the household income tends to be much lower for category 1: yes.

Finally, let us give some relative risk ratio measures with our new factors:


```{r}
coef(mod4_multi)
RRRf1 <- exp( coef(mod4_multi)[1,2]- coef(mod4_multi)[8,2] )
RRRf2 <- exp( coef(mod4_multi)[1,11]- coef(mod4_multi)[3,11] )
RRRf1
RRRf2
```
The risk ratio of being in household income category 1 (< 500) vs category 3 (1001 - 1500) for African Americans is 3.23 times that same risk ratio for people who preferred to not declare their ethnicity. 

The risk ratio of being in household income category 1 (< 500) vs category 3 (1001 – 1500) for women who completed 4 years of college is 0.72 times that same risk for women with no schooling. 


#############

Linear Model:
Our analysis plan does not include a linear model. However, our dataset includes data on the CD4 count of the study participants. This variable might be well suited for a linear model.
The CD4 count is given as number of CD4 cells per cubic mm.

The CD4 count was measured multiple times for some participants. To achieve independence of the data points we restrict ourselves to the CD4 count value measured at the first visit where the CD4 count was measured.

```{r}
lab = read.csv("./data/labsum.csv")
cleand_lab = list()
for(i in unique(lab$CASEID)){
  data_for_i = lab[lab$CASEID == i,]
  cleand_lab = rbind(cleand_lab,data_for_i[data_for_i$VISIT == min(data_for_i$VISIT, na.rm=T),])
}
cleand_lab = cleand_lab[!is.na(cleand_lab$CD4N),]
```

When then look at a histogram of the CD4 data to see if it is normally distributed
```{r}
hist(cleand_lab$CD4N)
```
We can see that the data is right skewed.
We therefore transform is by applying the square root function
```{r}
transformed_CD4 = sqrt(cleand_lab$CD4N)
hist_CD4 = hist(transformed_CD4,plot = F, prob=T)
m = mean(transformed_CD4)
std = sd(transformed_CD4)
plot(hist_CD4)
x = round(min(transformed_CD4)):round(max(transformed_CD4))
bin_width = hist_CD4$breaks[2]- hist_CD4$breaks[1]
lines(dnorm(x, mean=m, sd=std)*bin_width*length(transformed_CD4),
      col="darkblue", lwd=2, add=TRUE, yaxt="n")
```
This data is still not perfectly normal distributed, but it should be good enough.


We then need to add the CD4 data to our "all" dataframe. However, we do not have CD4 data for all Case IDs.
Because we do not need CD4 data for the rest of the project we creat a seperate data frame for this model that includes the data for all individual for which we have CD4 data
```{r}
all_with_CD4N = all
CD4N = c()
for(i in all_with_CD4N$CASEID){
  if(sum(cleand_lab$CASEID == i) ==1){
    CD4N = append(CD4N, cleand_lab$CD4N[cleand_lab$CASEID == i])
  }
  else{
    all_with_CD4N = all_with_CD4N[!(all_with_CD4N$CASEID==i),]
  }
}
length(all[,1])
length(all_with_CD4N[,1])
```

Our new data frame has 1208 instead of 1229 rows.

We then add the CD4 data and the transformed CD4 data to our data frame

```{r}
all_with_CD4N$CD4N = CD4N
all_with_CD4N$CD4N_t = sqrt(CD4N)
```

Model building:

We start with some exploratory analysis by looking at boxplots of the square root of the CD4 number for different values of our categorical predictor variables.
```{r}
boxplot(CD4N_t~ethnicity,data = all_with_CD4N)
boxplot(CD4N_t~drug,data = all_with_CD4N)
boxplot(CD4N_t~birth_country,data = all_with_CD4N)
boxplot(CD4N_t~educ_level,data = all_with_CD4N)
boxplot(CD4N_t~marital_status,data = all_with_CD4N)
boxplot(CD4N_t~ever_marijuana,data = all_with_CD4N)
boxplot(CD4N_t~shared_needles,data = all_with_CD4N)
boxplot(CD4N_t~ever_jail,data = all_with_CD4N)
boxplot(CD4N_t~ever_sex_with_hiv_male,data = all_with_CD4N)
boxplot(CD4N_t~ever_sex_with_gay_male,data = all_with_CD4N)
boxplot(CD4N_t~condom_use,data = all_with_CD4N)
boxplot(CD4N_t~ever_anal_sex,data = all_with_CD4N)
boxplot(CD4N_t~ever_sex_toys,data = all_with_CD4N)
boxplot(CD4N_t~sexual_orientation,data = all_with_CD4N)
boxplot(CD4N_t~hivstat,data = all_with_CD4N)

```
For most variables the boxplot does not show an association between the variable and the square root of the CD4 number.
However, for "ever sex with hiv male" the square root of the CD4 number seems to be higher for women who never had sex with a HIV positive men.
We also see a strong association with HIV status.
It also seems to be higher among women who never used condoms.

We then look at scatterplots for the continuous variables
```{r}
plot(CD4N_t~age,data = all_with_CD4N)
plot(CD4N_t~household_income,data = all_with_CD4N)
plot(CD4N_t~living_with,data = all_with_CD4N)
plot(CD4N_t~sex_partners,data = all_with_CD4N)
```
We again see no clear association between the variable and the square root of the CD4 number for most variables. With the one exception being household income, where there seems to be a negative lower average square root of the CD4 number for women with higerh houshold income.

Because there is no clear assosciation between most variables and the outcome and we have a large number of possible predictor variables, we start with a model that includes all possible predictor variables and elimnate some of them afterwasrd by backward selection.
```{r}
start_cd4 = lm(CD4N_t ~ as.factor(ethnicity) + as.factor(educ_level) + as.factor(marital_status) + living_with + household_income + as.factor(drug) + sex_partners + as.factor(ever_marijuana) + as.factor(shared_needles) + as.factor(ever_jail) + as.factor(ever_sex_with_hiv_male) + as.factor(ever_sex_with_gay_male) + as.factor(condom_use) + as.factor(ever_anal_sex) + as.factor(ever_sex_toys) + as.factor(sexual_orientation) +hivstat + age , data = all_with_CD4N)
summary(start_cd4)
```
```{r}
backwardModel_CD4 <- step(start_cd4, direction = "backward")
```
We perform backward selection by using the step() function that selects the best model by a stepwise backward alogrithm. It uses the AIC to find the "best" model.
```{r}
summary(backwardModel_CD4)
```
The model selected by backward selection includes the categorical variables marital status, ever shared needles, ever in jal and ever sex with a hiv positive male. It also includes household income and number of sex partners which are treated as a continious variable because they have 8/5 ordinal categories respectively. For income 1 being the lowest household income of 500$ or less and 8 being the highest with a household income of over 6250$.

Because the effect of household income is statistically highly significant with a p value < 0.005 we also looked if we could improve the model by including quadratic household income or treating household income as a categorical variable.

```{r}
all_with_CD4N$household_income2 = all_with_CD4N$household_income**2
backwardModel_CD4_modified = lm(CD4N_t ~ as.factor(marital_status) + household_income + household_income2 + sex_partners+ as.factor(shared_needles) + as.factor(ever_jail) + as.factor(ever_sex_with_hiv_male) + hivstat, data = all_with_CD4N)
backwardModel_CD4_modified_2 = lm(CD4N_t ~ as.factor(marital_status) + as.factor(household_income) + sex_partners+ as.factor(shared_needles) + as.factor(ever_jail) + as.factor(ever_sex_with_hiv_male) + hivstat, data = all_with_CD4N)
anova(backwardModel_CD4,backwardModel_CD4_modified)
anova(backwardModel_CD4, backwardModel_CD4_modified_2)
```
We compared the adjusted model to the original backward selected model using an Anova.
None of the two models are statistically significantly better at the alpha = 0.05 level.
We therefore continue with the original backward selected model and only consider linear household income.


We therefore select this model as our final model
```{r}
backwardModel_CD4_final = backwardModel_CD4
```

We then perform a residual analysis of the final model.
We plot the residuals against household income and created a histogram of the residuals.
```{r}
plot(all_with_CD4N$household_income,backwardModel_CD4_final$residuals)
hist(backwardModel_CD4_final$residuals)
plot(backwardModel_CD4_final$fitted.values,backwardModel_CD4_final$residuals)
```
From the histogram we see that the residuals seem to be normally distributed. Looking at the plot of household income we see that there seems to be equal variance for different values of household income.

We then plotted the fitted values of the square roots of CD4 number against the actual square roots of the CD4 number to look for potential outliers
```{r}
plot(all_with_CD4N$CD4N_t,backwardModel_CD4_final$fitted.values)
```
This scatterplot does not show any major outliers. We therefore keep all data points in the dataset.
We also see that there seem to be two groups, with the group in the upper left presumably being the individuals who do not have hiv.


```{r}
all_with_CD4N[all_with_CD4N$CD4N_t>20 & backwardModel_CD4_final$fitted.values>25,]$hivstat
```
A quick look at the data shows that this is indeed the case.

```{r}
all_with_CD4N[all_with_CD4N$CD4N_t>20 & backwardModel_CD4_final$fitted.values>25,]
```

This leaves us with our final model
```{r}
summary(backwardModel_CD4_final)
```

We see that a one unit increase in household income is associated with an estimated 0.282(95% CI [0.097, 0.467]) decrease in the square root of the number of CD4 cells per cubic millimeter, holding all other variables in the model constant.
We see further that a one unit increase in sex partners is associated with an estimated 0.449(95% CI [0.060, 0.838]) decrease in the square root of the number of CD4 cells per cubic millimeter, holding all other variables in the model constant.
For marital status we see that being widowed is associated with an estimated 1.92(95% CI [0.41, 3.43]) decrease in the square root of the number of CD4 cells per cubic millimeter compared to being married, holding all other variables constant.
We also see that being divorced is associated with an estimated 1.45(95% CI [0.05, 2.85]) decrease in the square root of the number of CD4 cells per cubic millimeter compared to being married, holding all other variables constant.

The biggest effect we see is hiv status. Being hiv positive is associated with a 12.20(95% CI [11.15, 13.26]) decrease in the square root of the number of CD4 cells per cubic millimeter compared to being hiv negative, holding all other variables constant.



##############################
Poisson Regression:

We want to predict the number of people a women with HIV lives with.

We begin with some exploratory analysis looking at a histogram of the number of people a study participant is living with
```{r}
hist(all$living_with)
```
The data looks suitable for a Poisson regression model. However, we have a lot of missing data. Missing data for this variable is encoded by a value of -1. From the Histogram we can see that this is the case for roughly 320 women in the study.
So for this model, we have to restrict ourselves to the women for whom we have data.

```{r}
all_with_living_with = all[all$living_with>-1,]
```
We create another histogram for the subset of the participants for whom we have data.
```{r}
hist(all_with_living_with$living_with)
```

We then look at boxplots of the number of people the women is living with for different values of our categorical predictor variables.



```{r}
boxplot(living_with~ethnicity,data = all_with_living_with)
boxplot(living_with~drug,data = all_with_living_with)
boxplot(living_with~birth_country,data = all_with_living_with)
boxplot(living_with~educ_level,data = all_with_living_with)
boxplot(living_with~marital_status,data = all_with_living_with)
boxplot(living_with~ever_marijuana,data = all_with_living_with)
boxplot(living_with~shared_needles,data = all_with_living_with)
boxplot(living_with~ever_jail,data = all_with_living_with)
boxplot(living_with~ever_sex_with_hiv_male,data = all_with_living_with)
boxplot(living_with~ever_sex_with_gay_male,data = all_with_living_with)
boxplot(living_with~condom_use,data = all_with_living_with)
boxplot(living_with~ever_anal_sex,data = all_with_living_with)
boxplot(living_with~ever_sex_toys,data = all_with_living_with)
boxplot(living_with~sexual_orientation,data = all_with_living_with)
boxplot(living_with~hivstat,data = all_with_living_with)
boxplot(living_with~speak_spanish,data = all_with_living_with)
boxplot(living_with~birth_country,data = all_with_living_with)

```
```
For most variables the boxplot does not show a clear association between the variable and the number of people a person is living with. The exception being education level where we can clrealy see that higher education level is associated with a lower number of people the women is living with.

We then look at scatterplots for the continuous variables.




```
```{r}
plot(living_with~age,data = all_with_living_with)
plot(living_with~household_income,data = all_with_living_with)
plot(living_with~sex_partners,data = all_with_living_with)

```
We see no clear association for sex partners and number of people living with. But tehre seems to be a negative correlation of number of people living with with both age and income.

We again start by looking at a model that includes all possible predictor variables and eliminate them by backward selection, optimizing the model to have low AIC.

```{r}
start_poisson = glm(living_with ~ as.factor(ethnicity) + as.factor(educ_level) + as.factor(marital_status)  + as.factor(drug) + as.factor(ever_marijuana) + as.factor(shared_needles) + as.factor(ever_jail) + as.factor(ever_sex_with_hiv_male) + as.factor(ever_sex_with_gay_male) + as.factor(condom_use) + as.factor(ever_anal_sex) + as.factor(ever_sex_toys) + as.factor(sexual_orientation) + as.factor(birth_country) + as.factor(speak_spanish)+hivstat + age + household_income + sex_partners , data = all_with_living_with, family = "poisson")
summary(start_poisson)
```

```{r}
backward_poisson <- step(start_poisson, direction = "backward")
```

```{r}
summary(backward_poisson)
```

We then compare our fitted values to the "raw" values
```{r}
hist(backward_poisson$fitted.values)
hist(all_with_living_with$living_with)
```
We then calculated the dispersion parameter
```{r}
deviance(backward_poisson)/ backward_poisson$df.residual
```

```{r}
library(AER)
dispersiontest(backward_poisson)
```

This tells us that we have overdispersion. We therfore should maybe consider an alternative model, e.g. a negative binomial model.

However, for now we continue with the Poisson model as the overdispersion is not to extreme.

```{r}
final_poisson = backward_poisson
summary(final_poisson)
```
```{r}
exp(10*coef(final_poisson)[length(coef(final_poisson))-2]+ 10* c ( -1 ,0, 1) * 1.96 * sqrt(vcov(final_poisson)[length(coef(final_poisson)-2) ,length(coef(final_poisson))-2]))
# exp(coef(final_poisson)[length(coef(final_poisson))-1]+ c ( -1 ,0, 1) * 1.96 * sqrt(vcov(final_poisson)[length(coef(final_poisson))-1 ,length(coef(final_poisson))-1]))
exp(coef(final_poisson)[length(coef(final_poisson))]+ c ( -1 ,0, 1) * 1.96 * sqrt(vcov(final_poisson)[length(coef(final_poisson)) ,length(coef(final_poisson))]))
```

We see that a 10 year increase in age is associated with an average decrease in the number of people a women is living with by a factor of 0.86 (95% CI: [0.79,0.93]), holding all other covariates constant and according to this data.

We see that a 1 unit increase in number of sex partners is associated with an average decrease in the number of people a women is living with by a factor of 0.92 (95% CI: [0.88,0.96]), holding all other covariates constant and according to this data.
```{r}
#education level
exp(coef(final_poisson)[12]+ c ( -1 ,0, 1) * 1.96 * sqrt(vcov(final_poisson)[12 ,12]))
exp(coef(final_poisson)[11]+ c ( -1 ,0, 1) * 1.96 * sqrt(vcov(final_poisson)[11 ,11]))
exp(coef(final_poisson)[9]+ c ( -1 ,0, 1) * 1.96 * sqrt(vcov(final_poisson)[9 ,9]))
```


We also see that attendence or completion of  graduate school vs no schooling is associated with an average decrease in the number of people a women is living with by a factor of 0.27 (95% CI: [0.14,0.53]), holding all other covariates constant and according to this data.
Completing 4 years of college vs no schooling is associated with an average decrease in the number of people a women is living with by a factor of 0.51 (95% CI: [0.31,0.85]), holding all other covariates constant and according to this data.
Completing grades 7-11 vs no schooling is associated with an average decrease in the number of people a women is living with by a factor of 0.72 (95% CI: [0.46,0.1.12]), holding all other covariates constant and according to this data.
```{r}
# widowed vs married
exp(coef(final_poisson)[17]+ c ( -1 ,0, 1) * 1.96 * sqrt(vcov(final_poisson)[17 ,17]))
```
Being widowed vs married is associated with an average decrease in the number of people a women is living with by a factor of 0.75 (95% CI: [0.67,0.84]), holding all other covariates constant and according to this data.


USING GGPLOT

```{r}
cleand_lab %>%
  ggplot()+
  geom_histogram(aes(x = CD4N, y = ..density..), color = "white")+
  labs(x = "Raw CD4 Count", y = "Proportion")

ggplot()+
  geom_histogram(aes(x = transformed_CD4, y = ..density..), color = "white")+
  labs(x = "Square Root of CD4 Count", y = "Proportion") + 
  stat_function(fun = dnorm, args = list(m, std), color = "red")
  

```

```{r}
all_with_CD4N %>% 
  ggplot() +
  geom_point(aes(x = as.factor(hivstat), y = backwardModel_CD4_final$fitted.values , color = as.factor(hivstat))) + 
  labs(x = "HIV status", y = "Predicted Square Root of CD4 count")+
  scale_color_discrete(name = "HIV status", labels = c("HIV Negative", "HIV Positive"))
```
plot(all_with_CD4N$CD4N_t,backwardModel_CD4_final$fitted.values)

```{r}
all_with_CD4N %>%
  ggplot() +
  geom_point(aes(x = CD4N_t, y = backwardModel_CD4_final$fitted.values, color = as.factor(hivstat)))+
  scale_color_discrete(name = "HIV status", labels = c("HIV Negative", "HIV Positive"))+
  labs(x = "Predicted Square Root of CD4 Count", y = "Measured Square Root of CD4 Count")

```

